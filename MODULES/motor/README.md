# 安全模块 (Safety Module)

## 模块架构 (2-Layer Architecture)

为了提高系统的可靠性与可维护性，安全模块采用由下至上的分层设计：

### 1. 故障检测层 (`fault_detection.c`)
**职责**: 纯物理量监测，不包含任何控制逻辑。
- **输入**: 电压、电流、温度、速度、时间戳
- **输出**: 原始故障位 (`FAULT_OVER_VOLTAGE`, `FAULT_STALL` 等)
- **特点**: 无状态，只负责 "看到了什么"。

### 2. 安全控制层 (`safety_control.c`)
**职责**: 系统级响应与状态管理。
- **职责**:
  1. 调用检测层获取状态。
  2. 故障确认与防抖 (Debounce)。
  3. 触发系统停机 (FSM Transition)。
  4. 上报故障信息 (CAN上报)。
- **特点**: 有状态，负责 "该做什么"。

## 扩展规划 (Roadmap)

为了进一步提升工业级可靠性，计划进行以下优化：

### 1. 自动恢复机制 (Auto-Recovery)
*   **现状**: 故障触发后永久锁死，需人工复位。
*   **规划**: 
    - 区分 **致命故障** (如过流/短路) 与 **临时故障** (如CAN瞬时超时)。
    - 对于临时故障，允许系统在 $T_{retry}$ 时间后尝试自动重启。
    - 引入 $N_{max}$ 重试计数器，超过次数后才永久锁死。

### 2. 黑匣子数据记录 (Blackbox Snapshot)
*   **现状**: 仅记录故障码与发生时间。
*   **规划**: 
    - 建立环形缓冲区，记录故障前 100ms 的关键数据 (Id, Iq, Vbus, Speed)。
    - 故障触发时冻结缓冲区，供上位机读取分析事故原因。

### 3. 分级故障响应 (Tiered Response)
*   **Level 1 (警告)**: 仅置位标志，不影响运行 (如: 温度 > 120℃)。
*   **Level 2 (降额)**: 限制最大力矩/速度 (如: 温度 > 130℃ 或 电压接近极限)。
*   **Level 3 (缓停)**: 受控减速停车 (如: 通信超时)。
*   **Level 4 (急停)**: 立即切断 PWM (如: 硬件过流、短路)。

### 4. 协议解耦 (Protocol Decoupling)
*   通过回调函数 (`Safety_SetReportCallback(...)`) 将故障上报逻辑与具体协议 (Inovxio/CANopen) 解耦。
