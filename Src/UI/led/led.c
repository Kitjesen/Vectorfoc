#include "led.h"
#include "board_config.h"

/* ?????????????? */
const RGB_Color_TypeDef RED = {255, 0, 0};        // ???
const RGB_Color_TypeDef GREEN = {0, 255, 0};      // ???
const RGB_Color_TypeDef BLUE = {0, 0, 255};       // ???
const RGB_Color_TypeDef SKY = {0, 255, 255};      // ?????
const RGB_Color_TypeDef MAGENTA = {255, 0, 220};  // ????
const RGB_Color_TypeDef YELLOW = {127, 216, 0};   // ???
const RGB_Color_TypeDef ORANGE = {127, 106, 0};   // ???
const RGB_Color_TypeDef BLACK = {0, 0, 0};        // ???
const RGB_Color_TypeDef WHITE = {255, 255, 255};  // ???
const RGB_Color_TypeDef PURPLE = {128, 0, 128};   // ???
const RGB_Color_TypeDef BROWN = {165, 42, 42};    // ???
const RGB_Color_TypeDef GRAY = {128, 128, 128};   // ???
const RGB_Color_TypeDef PINK = {255, 192, 203};   // ???
const RGB_Color_TypeDef GOLD = {255, 215, 0};     // ???
const RGB_Color_TypeDef SILVER = {192, 192, 192}; // ???

/* LED????????? */
uint32_t led_buf[LED_MAX_NUM + 1][24]; // LED_MAX_NUM + 1 ????????????? RESET ???

/**
 * @brief ?????? RGB LED ?????
 *
 * ?????????????? LED ????????????? LED ??????????
 *
 * @param LedId LED ????????? 0 ?? LED_MAX_NUM
 * @param Color ??????????? RGB ????????
 */
void RGB_SetColor(uint8_t LedId, RGB_Color_TypeDef Color)
{
    if (LedId > LED_MAX_NUM) // ??? LED ?????????
        return;              // ??????????

    // ????????????? PWM ??????????? led_buf ??
    for (uint8_t i = 0; i < 8; i++)
    {
        // ???? G???????????
        led_buf[LedId][i]      = (Color.G & (1 << (7 - i))) ? CODE_1 : CODE_0;
        // ???? R???????????
        led_buf[LedId][8 + i]  = (Color.R & (1 << (7 - i))) ? CODE_1 : CODE_0;
        // ???? B???????????
        led_buf[LedId][16 + i] = (Color.B & (1 << (7 - i))) ? CODE_1 : CODE_0;
    }
}

/**
 * @brief ????????? RESET ??
 *
 * ?????????? LED ?????????????????????????? RESET ????
 */
void Reset_Load(void)
{
    memset(led_buf[LED_MAX_NUM], 0, sizeof(led_buf[LED_MAX_NUM])); // ?????????????
}

/**
 * @brief ???? LED ????
 *
 * ???????? DMA ???? PWM ??????? LED ?????????????
 */
void RGB_SendArray(void)
{
    HAL_TIM_PWM_Start_DMA(&HW_LED_TIMER, HW_LED_CHANNEL, (uint32_t *)led_buf, (LED_MAX_NUM + 1) * 24); // ???? PWM ???
}

/**
 * @brief ?????????
 *
 * ????????????????????? LED??
 *
 * @param color ??????????? RGB ????????
 */
void RGB_DisplayColor(RGB_Color_TypeDef color)
{
    for (uint16_t i = 0; i < LED_MAX_NUM; i++) // ???????? LED
    {
        RGB_SetColor(i, color); // ??????? LED ?????
    }
    Reset_Load();    // ???? RESET ???
    RGB_SendArray(); // ????????? LED
}

/**
 * @brief ????????????????
 *
 * ?????????????????????????????????
 *
 * @param color_id ???????????? 0 ?? 14????????????????
 */
void RGB_DisplayColorById(uint8_t color_id)
{
    RGB_Color_TypeDef color; // ??????????????

    // ????????????????????
    switch (color_id)
    {
    case 0:
        color = RED; // ???
        break;
    case 1:
        color = GREEN; // ???
        break;
    case 2:
        color = BLUE; // ???
        break;
    case 3:
        color = SKY; // ?????
        break;
    case 4:
        color = MAGENTA; // ????
        break;
    case 5:
        color = YELLOW; // ???
        break;
    case 6:
        color = ORANGE; // ???
        break;
    case 7:
        color = BLACK; // ???
        break;
    case 8:
        color = WHITE; // ???
        break;
    case 9:
        color = PURPLE; // ???
        break;
    case 10:
        color = BROWN; // ???
        break;
    case 11:
        color = GRAY; // ???
        break;
    case 12:
        color = PINK; // ???
        break;
    case 13:
        color = GOLD; // ???
        break;
    case 14:
        color = SILVER; // ???
        break;
    default:
        color = BLACK; // ??????????
        break;
    }

    RGB_DisplayColor(color); // ??????????????
}

/**
 * @brief DMA???????????????
 *
 * ??????? DMA ???????????????????? PWM ???????????????
 */
void RGB_DMA_CompleteCallback(void)
{
    HAL_TIM_PWM_Stop_DMA(&HW_LED_TIMER, HW_LED_CHANNEL); // ?? DMA PWM ???
}
